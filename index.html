<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>Terminal App</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#1E3246">
  <!-- Material Symbols -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
</head>
<body class="flex flex-col h-screen bg-gray-50 text-gray-800">

  <!-- HEADER -->
  <header class="bg-[#1E3246] text-white p-4 shadow-md">
    <h1 class="text-xl font-semibold">Terminal App</h1>
  </header>

  <!-- MAIN -->
  <main class="flex-1 overflow-auto p-4 space-y-6">

    <!-- ERFASSEN -->
    <section id="tab-erfassen" class="space-y-6">
      <div class="bg-white p-6 rounded-2xl shadow-lg space-y-4">

        <!-- Standort -->
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
          <div>
            <label class="block text-sm font-medium text-gray-600">Halle</label>
            <select id="hall" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:ring-[#1E3246] focus:border-[#1E3246]">
              <option value="">– wählen –</option>
              <option>110</option><option>111</option><option>F</option><option>Geb.23</option>
              <option>M</option><option>M+</option><option>M++</option><option>N</option>
              <option>O</option><option>Q</option><option>S</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600">Station</label>
            <select id="station" disabled class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:ring-[#1E3246] focus:border-[#1E3246]">
              <option value="">– wählen –</option>
              <script>for(let r=1;r<=9;r++)for(let c=1;c<=3;c++)document.write(`<option>${r}-${c}</option>`);</script>
              <option>F21</option><option>F22</option><option>F23</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600">Ebene</label>
            <select id="ebene" disabled class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:ring-[#1E3246] focus:border-[#1E3246]">
              <option value="">– wählen –</option>
              <option>Dach</option><option>Mitte</option><option>Ug</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600">Terminal-Nummer</label>
            <input id="tid" type="text" maxlength="2" placeholder="z.B. 01"
                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:ring-[#1E3246] focus:border-[#1E3246]" />
          </div>
        </div>

        <!-- OCR-Felder -->
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
          <div>
            <label class="block text-sm font-medium text-gray-600">Rechner S/N</label>
            <div class="mt-1 flex gap-2">
              <input id="rechnerSN" readonly
                     class="flex-1 rounded-lg border-gray-300 bg-gray-100 px-3 py-2 shadow-sm"/>
              <button id="ocrRechner"
                      class="inline-flex items-center gap-1 px-3 py-2 bg-[#E2001A] text-white rounded-lg shadow hover:bg-[#c60016]">
                <span class="material-symbols-outlined">camera_alt</span>
              </button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-600">Monitor S/N</label>
            <div class="mt-1 flex gap-2">
              <input id="monitorSN" readonly
                     class="flex-1 rounded-lg border-gray-300 bg-gray-100 px-3 py-2 shadow-sm"/>
              <button id="ocrMonitor"
                      class="inline-flex items-center gap-1 px-3 py-2 bg-[#E2001A] text-white rounded-lg shadow hover:bg-[#c60016]">
                <span class="material-symbols-outlined">camera_alt</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Save -->
        <button id="btnSave" disabled
                class="w-full inline-flex items-center justify-center gap-2 py-2 bg-[#1E3246] text-white rounded-lg shadow hover:bg-[#16314d] disabled:opacity-50">
          <span class="material-symbols-outlined">save</span>
          Terminal speichern
        </button>
      </div>
    </section>

    <!-- ÜBERSICHT -->
    <section id="tab-uebersicht" class="hidden space-y-4">
      <div class="flex justify-end">
        <button id="exportBtn"
                class="inline-flex items-center gap-2 py-2 px-4 bg-[#E2001A] text-white rounded-lg shadow hover:bg-[#c60016]">
          <span class="material-symbols-outlined">download</span>
          Export CSV
        </button>
      </div>
      <div id="entries" class="space-y-4"></div>
    </section>

  </main>

  <!-- NAV -->
  <nav class="flex border-t bg-white">
    <button id="nav-erfassen" class="flex-1 py-3 text-center hover:bg-gray-100">
      <div class="material-symbols-outlined mx-auto">add</div>
      <div class="text-sm">Erfassen</div>
    </button>
    <button id="nav-uebersicht" class="flex-1 py-3 text-center hover:bg-gray-100">
      <div class="material-symbols-outlined mx-auto">list</div>
      <div class="text-sm">Übersicht</div>
    </button>
  </nav>

  <!-- TOAST -->
  <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-[#1E3246] text-white px-4 py-2 rounded-lg opacity-0 transition-opacity"></div>

  <!-- Tesseract.js -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script>
  // Service Worker
  if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');

  // DOM
  const hall = document.getElementById('hall'),
        station = document.getElementById('station'),
        ebene = document.getElementById('ebene'),
        tid = document.getElementById('tid'),
        rechnerSN = document.getElementById('rechnerSN'),
        monitorSN = document.getElementById('monitorSN'),
        btnOCRRechner = document.getElementById('ocrRechner'),
        btnOCRMonitor  = document.getElementById('ocrMonitor'),
        btnSave        = document.getElementById('btnSave'),
        exportBtn      = document.getElementById('exportBtn'),
        entries        = document.getElementById('entries'),
        toast          = document.getElementById('toast'),
        KEY            = 'terminals_db';

  // Navigation
  document.getElementById('nav-erfassen').onclick = ()=> showTab('erfassen');
  document.getElementById('nav-uebersicht').onclick = ()=> { showTab('uebersicht'); renderList(); };

  function showTab(name){
    ['erfassen','uebersicht'].forEach(t=>
      document.getElementById('tab-'+t).classList.toggle('hidden', t!==name)
    );
  }

  // Toast
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('opacity-100');
    setTimeout(()=> toast.classList.remove('opacity-100'), 2000);
  }

  // Storage
  const getData = ()=> JSON.parse(localStorage.getItem(KEY)||'[]'),
        setData = d=> localStorage.setItem(KEY, JSON.stringify(d));

  // Enable dropdowns + validation
  hall.onchange = ()=>{
    station.disabled = !hall.value;
    ebene.disabled = !hall.value;
    validate();
  };
  [station, ebene].forEach(el=> el.onchange = validate);
  tid.oninput = validate;

  function validate(){
    btnSave.disabled = !(
      hall.value &&
      station.value &&
      ebene.value &&
      /^\d{2}$/.test(tid.value.trim()) &&
      rechnerSN.value &&
      monitorSN.value
    );
  }

  // OCR Funktion mit Preprocessing & Whitelist
  async function doOCR(targetInput){
    showToast('OCR startet…');
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }});
      const video = document.createElement('video');
      video.srcObject = stream;
      await video.play();

      const c = document.createElement('canvas');
      c.width = video.videoWidth; c.height = video.videoHeight;
      const ctx = c.getContext('2d');
      ctx.drawImage(video,0,0);

      // Stop camera
      stream.getTracks().forEach(t=>t.stop());

      // Graustufen
      let img = ctx.getImageData(0,0,c.width,c.height);
      for(let i=0;i<img.data.length;i+=4){
        const avg = (img.data[i]+img.data[i+1]+img.data[i+2])/3;
        img.data[i]=img.data[i+1]=img.data[i+2]=avg;
      }
      ctx.putImageData(img,0,0);

      // Binarisierung
      let bin = ctx.getImageData(0,0,c.width,c.height);
      const thresh = 150;
      for(let i=0;i<bin.data.length;i+=4){
        const v = bin.data[i] > thresh ? 255 : 0;
        bin.data[i]=bin.data[i+1]=bin.data[i+2]=v;
      }
      ctx.putImageData(bin,0,0);

      // OCR
      const { data:{ text }} = await Tesseract.recognize(
        c.toDataURL(),
        'deu+eng',
        { tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789' }
      );

      // Muster extrahieren
      const m = text.match(/([A-Z0-9\-]{4,})/);
      targetInput.value = m ? m[1].trim() : '';
      showToast(targetInput.value ? 'Erkannt: '+targetInput.value : 'Keine SN gefunden');
      validate();

    } catch(err) {
      console.error(err);
      alert('Kamera/OCR Fehler: ' + err.message);
    }
  }

  btnOCRRechner.onclick = ()=> doOCR(rechnerSN);
  btnOCRMonitor.onclick  = ()=> doOCR(monitorSN);

  // Speichern
  btnSave.onclick = ()=>{
    const entry = {
      hall: hall.value,
      station: station.value,
      ebene: ebene.value,
      tid: `AOS ${tid.value.trim()}`,
      rechnerSN: rechnerSN.value,
      monitorSN: monitorSN.value
    };
    const db = getData();
    if(db.some(e=>e.tid===entry.tid)) return showToast('Terminal existiert schon');
    db.push(entry); setData(db);
    showToast('Terminal gespeichert');
    // reset
    [hall,station,ebene,tid,rechnerSN,monitorSN].forEach(e=>e.value='');
    station.disabled=ebene.disabled=true; btnSave.disabled=true;
  };

  // Übersicht rendern
  function renderList(){
    const db = getData();
    entries.innerHTML = '';
    if(!db.length){
      entries.innerHTML = `<p class="text-center text-gray-500">Keine Einträge</p>`;
      return;
    }
    db.forEach((e,i)=>{
      const card = document.createElement('div');
      card.className = 'bg-white p-4 rounded-2xl shadow flex justify-between items-start';
      card.innerHTML = `
        <div>
          <p class="font-semibold text-[#1E3246]">${e.tid}</p>
          <p>${e.hall} / ${e.station} / ${e.ebene}</p>
          <p class="mt-1"><span class="font-medium">Rechner S/N:</span> ${e.rechnerSN}</p>
          <p><span class="font-medium">Monitor S/N:</span> ${e.monitorSN}</p>
        </div>
        <button data-i="${i}" class="material-symbols-outlined text-[#E2001A]">delete</button>`;
      entries.append(card);
      card.querySelector('button').onclick = ()=>{
        const db2 = getData();
        db2.splice(i,1);
        setData(db2);
        renderList();
        showToast('Gelöscht');
      };
    });
  }

  // CSV Export
  exportBtn.onclick = ()=>{
    const db = getData();
    if(!db.length) return showToast('Keine Daten');
    const rows = [['Terminal','Halle','Station','Ebene','RechnerSN','MonitorSN'],
                  ...db.map(e=>[e.tid,e.hall,e.station,e.ebene,e.rechnerSN,e.monitorSN])];
    const csv = rows.map(r=>r.map(c=>`"${c}"`).join(',')).join('\n');
    const blob = new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob), a=document.createElement('a');
    a.href = url; a.download = 'terminals.csv'; a.click(); URL.revokeObjectURL(url);
    showToast('Export abgeschlossen');
  };
  </script>
</body>
</html> 
